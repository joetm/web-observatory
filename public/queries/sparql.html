<h2>SPARQL</h2>

<span id="endpoint"></span>

</div> <pre class='pre-scrollable' id="prefixestext"> </pre>

<div>
    <textarea name="query" rows="5" id="querytext" class="span7"></textarea>
</div>
<br>
<div>Results:
    <select id="selectoutput" onchange="outputChanged(this.value)">
        <option value="application/sparql-results+json">Browse</option>
    </select> <span id="xsltcontainer"></span>

    <br>
    <button type="button" class="btn btn-primary" onclick="submitQuery()">Submit</button>
    <button type="button" class="btn btn-warning" onclick="resetQuery()">Reset</button>
    <button class='btn btn-inverse' onclick="cls()">Close</button>
</div>
<script src="/js/sparql.js"></script>
<script>
    var endpointURL = '';
    var defaultGraphURI = '';
    var namespaces = {
        'http://www.w3.org/2002/07/owl#': 'owl',
        'http://www.w3.org/2001/XMLSchema#': 'xsd',
        'http://www.w3.org/2000/01/rdf-schema#': 'rdfs',
        'http://www.w3.org/1999/02/22-rdf-syntax-ns#': 'rdf',
        'http://xmlns.com/foaf/0.1/': 'foaf',
        'http://purl.org/dc/elements/1.1/': 'dc',
        'http://dbpedia.org/resource/': '',
        'http://dbpedia.org/property/': 'dbpedia2',
        'http://dbpedia.org/': 'dbpedia',
        'http://www.w3.org/2004/02/skos/core#': 'skos'
    };

    function toPrefixesText(namespaces)
    {
        var result = '';
        for (var uri in namespaces)
        {
            result += 'PREFIX ' + namespaces[uri] + ': <' + uri + '> ';
        }
        return result;
    }

    function toPrefixesHTML(namespaces)
    {
        var result = '';
        for (var uri in namespaces)
        {
            result += 'PREFIX ' + namespaces[uri] + ': &lt' + uri + '&gt\n';
        }
        return result;
    }

    function betterUnescape(s)
    {
        return unescape(s.replace(/\+/g, ' '));
    }

    function start()
    {
        setPrefixes(toPrefixesHTML(namespaces));
    }
    var service;

    function setEndpointURL(url, defaultGraphURI)
    {
        $("#endpoint").text(url);
        $('#defaultgraph').val(defaultGraphURI);
        service = new SPARQL.Service(url);
        service.setMethod('GET');
        if (defaultGraphURI)
        {
            service.addDefaultGraph(defaultGraphURI);
        }
    }

    function setPrefixes(prefixes)
    {
        $('#prefixestext').html(prefixes);
    }

    function doQuery(sparql, callback)
    {

        setResult(busy);
        service.query(sparql,
        {
            success: callback,
            failure: onFailure
        });
    }

    function displayResult(json, resultTitle)
    {
        var div = document.createElement('div');
        var title = document.createElement('h2');
        title.appendChild(document.createTextNode(resultTitle));
        div.appendChild(title);
        if (json.results.bindings.length == 0)
        {
            var p = document.createElement('p');
            p.className = 'empty';
            p.appendChild(document.createTextNode('[no results]'));
            div.appendChild(p);
        }
        else
        {
            div.appendChild(jsonToHTML(json));
        }
        setResult(div);
    }


    function submitQuery()
    {
        var output = $('#selectoutput').val();
        var query = toPrefixesText(namespaces) + $('#querytext').val();
        var busy = $('<div class="alert alert-info"> Executing query ...</div>');

        setResult(busy);
        $.get('/query?query=' + encodeURIComponent(query) + '&format=' + encodeURIComponent(output), function(data)
        {
            var bindings = data.results.bindings;
            var res = '<h2>Results</h2> <table class="table table-stripe">';
            var tem = bindings[0];
            var th = '<thead>';
            for (var key in tem)
            {
                th += '<td>' + key + '</td>';
            }
            th += '</thead>';

            res += th;
            for (i = 0; i < bindings.length; i++)
            {
                var binding = bindings[i];
                var line = '<tr>';
                for (var key in binding)
                {
                    line += '<td>' + binding[key].value + '</td>';
                }
                line += '</tr>';
                res += line;
            }

            res += '</table>';
            res = $(res);
            setResult(res);
        });
    }

    function resetQuery()
    {
        $("#querytext").val("SELECT * \nWHERE {\n...\n}");
    }

    function onFailure(report)
    {
        var message = report.responseText.match(/<pre>([\s\S]*)<\/pre>/);
        if (message)
        {
            var pre = document.createElement('pre');
            pre.innerHTML = message[1];
            setResult(pre);
        }
        else
        {
            var div = document.createElement('div');
            div.innerHTML = report.responseText;
            setResult(div);
        }
    }

    function setResult(node)
    {
        display(node, 'result');
    }

    function display(node, dsp_id)
    {
        var dsp = $('#' + dsp_id);
        if (!dsp)
        {
            alert('ID not found: ' + whereID);
            return;
        }
        dsp.empty();
        if (node == null) return;
        dsp.append(node);
    }

    function cls()
    {
        $('#query-frame').empty();
        $('#result').empty();
    }
    resetQuery();
</script>
